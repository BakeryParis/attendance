<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>HR Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dayjs/1.11.10/dayjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="icon" type="image/png" href="favicon.png">

    <style>
        :root {
            --tally-blue: #011E41;
            --tally-light-blue: #0A3C6B;
            --tally-green: #388E3C;
            --tally-red: #D32F2F;
            --tally-bg-light: #F0F2F5;
            --tally-bg-card: #FFFFFF;
            --tally-text-dark: #212121;
            --tally-text-light: #757575;
            --tally-border: #E0E0E0;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--tally-bg-light);
            color: var(--tally-text-dark);
        }

        .scrollbar-hide::-webkit-scrollbar {
            display: none;
        }

        .scrollbar-hide {
            -ms-overflow-style: none;
            scrollbar-width: none;
        }

        .tally-card {
            background-color: var(--tally-bg-card);
            border: 1px solid var(--tally-border);
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
            transition: transform 0.2s;
        }

        .tally-card:hover {
            transform: translateY(-2px);
        }

        .tally-btn {
            background-color: var(--tally-blue);
            color: white;
            padding: 10px 16px;
            border-radius: 6px;
            transition: background-color 0.2s;
        }

        .tally-btn:hover {
            background-color: var(--tally-light-blue);
        }

        .tally-btn-outline {
            background-color: transparent;
            color: var(--tally-blue);
            border: 1px solid var(--tally-blue);
            padding: 10px 16px;
            border-radius: 6px;
            transition: background-color 0.2s, color 0.2s;
        }

        .tally-btn-outline:hover {
            background-color: var(--tally-blue);
            color: white;
        }
    </style>
</head>
<body class="flex min-h-screen">
    <!-- Sidebar -->
    <aside class="w-64 bg-[var(--tally-blue)] text-white p-4 space-y-4 flex flex-col items-center">
        <h1 class="text-2xl font-bold mb-6 text-white text-center">Tally HR</h1>
        <nav class="w-full">
            <ul class="space-y-2">
                <li>
                    <a href="#dashboard" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-[var(--tally-light-blue)] transition-colors active">
                        <i class="fa-solid fa-gauge mr-3"></i>
                        <span>Dashboard</span>
                    </a>
                </li>
                <li>
                    <a href="#reports" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-[var(--tally-light-blue)] transition-colors">
                        <i class="fa-solid fa-chart-line mr-3"></i>
                        <span>Reports</span>
                    </a>
                </li>
                <li>
                    <a href="#history" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-[var(--tally-light-blue)] transition-colors">
                        <i class="fa-solid fa-clock-rotate-left mr-3"></i>
                        <span>History</span>
                    </a>
                </li>
                <li>
                    <a href="#manage-employees" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-[var(--tally-light-blue)] transition-colors">
                        <i class="fa-solid fa-users mr-3"></i>
                        <span>Manage Employees</span>
                    </a>
                </li>
                <li>
                    <a href="#add-employee" class="sidebar-item flex items-center p-3 rounded-lg hover:bg-[var(--tally-light-blue)] transition-colors">
                        <i class="fa-solid fa-user-plus mr-3"></i>
                        <span>Add New Employee</span>
                    </a>
                </li>
            </ul>
        </nav>
    </aside>

    <!-- Main Content -->
    <main class="flex-grow p-8 overflow-y-auto scrollbar-hide">
        <header class="flex justify-between items-center mb-8 pb-4 border-b border-[var(--tally-border)]">
            <h2 id="page-title" class="text-3xl font-bold">Dashboard</h2>
        </header>

        <!-- Dashboard Section -->
        <section id="dashboard" class="page-section space-y-8">
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Total Employees Card -->
                <div class="tally-card p-6 flex items-center">
                    <div class="bg-blue-100 text-[var(--tally-blue)] rounded-full p-3 mr-4">
                        <i class="fa-solid fa-users fa-xl"></i>
                    </div>
                    <div>
                        <p class="text-[var(--tally-text-light)]">Total Employees</p>
                        <p id="totalEmployees" class="text-3xl font-bold">...</p>
                    </div>
                </div>

                <!-- Present Employees Card -->
                <div class="tally-card p-6 flex items-center">
                    <div class="bg-green-100 text-[var(--tally-green)] rounded-full p-3 mr-4">
                        <i class="fa-solid fa-user-check fa-xl"></i>
                    </div>
                    <div>
                        <p class="text-[var(--tally-text-light)]">Present Today</p>
                        <p id="presentEmployees" class="text-3xl font-bold">...</p>
                    </div>
                </div>

                <!-- Absent Employees Card -->
                <div class="tally-card p-6 flex items-center">
                    <div class="bg-red-100 text-[var(--tally-red)] rounded-full p-3 mr-4">
                        <i class="fa-solid fa-user-slash fa-xl"></i>
                    </div>
                    <div>
                        <p class="text-[var(--tally-text-light)]">Absent Today</p>
                        <p id="absentEmployees" class="text-3xl font-bold">...</p>
                    </div>
                </div>
            </div>

            <!-- Dashboard Controls -->
            <div class="tally-card p-6 space-y-4">
                <div class="flex flex-col md:flex-row items-center justify-between gap-4">
                    <div class="flex items-center gap-4">
                        <label for="date-filter" class="font-medium text-[var(--tally-text-dark)]">Select Date:</label>
                        <input type="date" id="date-filter" class="rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]">
                    </div>
                    <div class="flex items-center gap-2">
                        <input type="checkbox" id="show-relocated-only" class="rounded text-[var(--tally-blue)] focus:ring-0">
                        <label for="show-relocated-only" class="text-[var(--tally-text-dark)]">Show Relocated Only</label>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                    <button id="download-summary-pdf" class="tally-btn flex items-center justify-center">
                        <i class="fa-solid fa-file-pdf mr-2"></i>
                        <span>Summary PDF</span>
                    </button>
                    <button id="download-present-pdf" class="tally-btn flex items-center justify-center">
                        <i class="fa-solid fa-file-pdf mr-2"></i>
                        <span>Present List PDF</span>
                    </button>
                    <button id="download-absent-pdf" class="tally-btn flex items-center justify-center">
                        <i class="fa-solid fa-file-pdf mr-2"></i>
                        <span>Absent List PDF</span>
                    </button>
                    <button id="download-attendance-sheet-excel" class="tally-btn-outline flex items-center justify-center col-span-1 md:col-span-3">
                        <i class="fa-solid fa-file-excel mr-2"></i>
                        <span>Download Attendance Sheet (Excel)</span>
                    </button>
                </div>
            </div>

            <!-- Attendance Tables -->
            <div id="attendance-lists" class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <!-- Present List -->
                <div class="tally-card p-6">
                    <h3 class="text-xl font-semibold mb-4">Present Employees</h3>
                    <div class="overflow-x-auto scrollbar-hide">
                        <table class="w-full table-auto">
                            <thead class="bg-[var(--tally-bg-light)]">
                                <tr class="text-left text-sm font-semibold">
                                    <th class="p-3">ID</th>
                                    <th class="p-3">Name</th>
                                    <th class="p-3">Location</th>
                                </tr>
                            </thead>
                            <tbody id="present-list" class="divide-y divide-[var(--tally-border)]">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
                <!-- Absent List -->
                <div class="tally-card p-6">
                    <h3 class="text-xl font-semibold mb-4">Absent Employees</h3>
                    <div class="overflow-x-auto scrollbar-hide">
                        <table class="w-full table-auto">
                            <thead class="bg-[var(--tally-bg-light)]">
                                <tr class="text-left text-sm font-semibold">
                                    <th class="p-3">ID</th>
                                    <th class="p-3">Name</th>
                                </tr>
                            </thead>
                            <tbody id="absent-list" class="divide-y divide-[var(--tally-border)]">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </section>

        <!-- Reports Section -->
        <section id="reports" class="page-section hidden space-y-6">
            <h2 class="text-3xl font-bold">Reports</h2>
            <div class="tally-card p-6">
                <h3 class="text-xl font-semibold mb-4">Employee Activity Report</h3>
                <div class="flex items-center gap-4 mb-4">
                    <label for="report-month-filter" class="font-medium">Select Month:</label>
                    <input type="month" id="report-month-filter" class="rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]">
                </div>
                <div class="overflow-x-auto scrollbar-hide">
                    <table class="w-full table-auto">
                        <thead class="bg-[var(--tally-bg-light)]">
                            <tr class="text-left text-sm font-semibold">
                                <th class="p-3">Username</th>
                                <th class="p-3">Name</th>
                                <th class="p-3">Relocated</th>
                                <th class="p-3">Present Count</th>
                                <th class="p-3">Absent Count</th>
                            </tr>
                        </thead>
                        <tbody id="report-table" class="divide-y divide-[var(--tally-border)]">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- History Section -->
        <section id="history" class="page-section hidden space-y-6">
            <h2 class="text-3xl font-bold">Attendance History</h2>
            <div class="tally-card p-6">
                <h3 class="text-xl font-semibold mb-4">Employee Attendance History</h3>
                <div class="flex flex-wrap items-center gap-4 mb-4">
                    <label for="month-filter" class="font-medium">Select Month:</label>
                    <input type="month" id="month-filter" class="rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]">
                    <label for="employee-select" class="font-medium">Select Employee:</label>
                    <select id="employee-select" class="rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]"></select>
                    <button id="export-history-excel" class="tally-btn-outline flex items-center justify-center">
                        <i class="fa-solid fa-file-excel mr-2"></i>
                        <span>Export to Excel</span>
                    </button>
                </div>
                <div class="overflow-x-auto scrollbar-hide">
                    <table class="w-full table-auto">
                        <thead class="bg-[var(--tally-bg-light)]">
                            <tr class="text-left text-sm font-semibold">
                                <th class="p-3">Date</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">In Time</th>
                                <th class="p-3">Out Time</th>
                            </tr>
                        </thead>
                        <tbody id="employee-history-table" class="divide-y divide-[var(--tally-border)]">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Manage Employees Section -->
        <section id="manage-employees" class="page-section hidden space-y-6">
            <h2 class="text-3xl font-bold">Manage Employees</h2>
            <div class="tally-card p-6">
                <h3 class="text-xl font-semibold mb-4">Employee List</h3>
                <div class="overflow-x-auto scrollbar-hide">
                    <table class="w-full table-auto">
                        <thead class="bg-[var(--tally-bg-light)]">
                            <tr class="text-left text-sm font-semibold">
                                <th class="p-3">Username</th>
                                <th class="p-3">Name</th>
                                <th class="p-3">Status</th>
                                <th class="p-3">Relocated</th>
                                <th class="p-3">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="manage-employee-list" class="divide-y divide-[var(--tally-border)]">
                            <!-- Data will be loaded here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </section>

        <!-- Add Employee Section -->
        <section id="add-employee" class="page-section hidden space-y-6">
            <h2 class="text-3xl font-bold">Add New Employee</h2>
            <div class="tally-card p-6">
                <h3 class="text-xl font-semibold mb-4">Add Employee Form</h3>
                <form id="add-employee-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="new-username" class="block font-medium mb-1">Username (Email):</label>
                            <input type="email" id="new-username" required class="w-full rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]">
                        </div>
                        <div>
                            <label for="new-name" class="block font-medium mb-1">Full Name:</label>
                            <input type="text" id="new-name" required class="w-full rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]">
                        </div>
                        <div>
                            <label for="new-store" class="block font-medium mb-1">Store Location:</label>
                            <select id="new-store" required class="w-full rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]">
                                <option value="">Select Store</option>
                            </select>
                        </div>
                        <div>
                            <label for="new-status" class="block font-medium mb-1">Status:</label>
                            <select id="new-status" required class="w-full rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]">
                                <option value="Active">Active</option>
                                <option value="Inactive">Inactive</option>
                            </select>
                        </div>
                        <div class="flex items-center gap-2">
                            <input type="checkbox" id="new-relocated" class="rounded text-[var(--tally-blue)] focus:ring-0">
                            <label for="new-relocated" class="font-medium">Relocated Employee</label>
                        </div>
                    </div>
                    <button type="submit" class="tally-btn w-full mt-4">Add Employee</button>
                </form>
            </div>
        </section>

        <!-- Manual Attendance Section -->
        <section id="manual-attendance" class="page-section hidden space-y-6">
            <h2 class="text-3xl font-bold">Manual Attendance</h2>
            <div class="tally-card p-6">
                <h3 class="text-xl font-semibold mb-4">Record Attendance Manually</h3>
                <form id="manual-attendance-form" class="space-y-4">
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div>
                            <label for="employee-username" class="block font-medium mb-1">Username (Email):</label>
                            <input type="email" id="employee-username" required class="w-full rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]">
                        </div>
                        <div>
                            <label for="attendance-date" class="block font-medium mb-1">Date:</label>
                            <input type="date" id="attendance-date" required class="w-full rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]">
                        </div>
                        <div>
                            <label for="attendance-status" class="block font-medium mb-1">Status:</label>
                            <select id="attendance-status" required class="w-full rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]">
                                <option value="Present">Present</option>
                                <option value="Absent">Absent</option>
                                <option value="Half Day">Half Day</option>
                            </select>
                        </div>
                        <div>
                            <label for="attendance-time" class="block font-medium mb-1">Time (Optional):</label>
                            <input type="time" id="attendance-time" class="w-full rounded-md border border-[var(--tally-border)] p-2 focus:outline-none focus:ring-1 focus:ring-[var(--tally-blue)]">
                        </div>
                    </div>
                    <button type="submit" class="tally-btn w-full mt-4">Save Attendance</button>
                </form>
            </div>
        </section>
        
        <!-- Custom Modal for Alerts and Confirmations -->
        <div id="custom-modal" class="fixed inset-0 z-50 flex items-center justify-center bg-gray-900 bg-opacity-50 hidden">
            <div class="bg-white p-6 rounded-lg shadow-xl w-96">
                <h3 id="modal-title" class="text-lg font-semibold mb-4"></h3>
                <p id="modal-message" class="text-sm text-gray-700 mb-6"></p>
                <div id="modal-actions" class="flex justify-end space-x-2">
                    <!-- Buttons will be injected here -->
                </div>
            </div>
        </div>
    </main>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, addDoc, getDoc, doc, setDoc, updateDoc, getDocs, onSnapshot, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Global variables provided by the environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        // --- Firebase Initialization and Auth ---
        let db, auth;
        let userId = 'anonymous';

        const setupFirebase = async () => {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    console.error("Firebase config is empty. Please ensure it's provided.");
                    return;
                }
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }
                userId = auth.currentUser?.uid || 'anonymous';
                console.log("Firebase initialized successfully. User ID:", userId);
                initApp();
            } catch (error) {
                console.error("Error setting up Firebase:", error);
                showModal('Error', `Failed to initialize application. Please try again.`, ['OK']);
            }
        };

        // --- UI & State Management ---
        const sidebarItems = document.querySelectorAll('.sidebar-item');
        const pageSections = document.querySelectorAll('.page-section');
        const pageTitle = document.getElementById('page-title');

        let allEmployees = [];
        let allStores = [];
        let selectedDate = dayjs().format('YYYY-MM-DD');
        let selectedMonth = dayjs().format('YYYY-MM');
        let selectedEmployeeUsername = '';
        let showRelocatedOnly = false;

        // --- Utility Functions ---
        const showModal = (title, message, buttons, callback = null) => {
            const modal = document.getElementById('custom-modal');
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            const actionsContainer = document.getElementById('modal-actions');
            actionsContainer.innerHTML = '';
            
            buttons.forEach(btnText => {
                const button = document.createElement('button');
                button.innerText = btnText;
                button.className = 'tally-btn';
                button.onclick = () => {
                    modal.classList.add('hidden');
                    if (callback && btnText === 'Confirm') {
                        callback();
                    }
                };
                actionsContainer.appendChild(button);
            });
            modal.classList.remove('hidden');
        };

        // --- Data Fetching & Rendering ---
        const getCollectionRef = (name) => collection(db, `artifacts/${appId}/public/data/${name}`);

        const loadEmployees = async () => {
            try {
                const q = query(getCollectionRef('employees'));
                const querySnapshot = await getDocs(q);
                allEmployees = querySnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                loadEmployeeSelectOptions();
                await loadDashboardData(selectedDate);
                await loadReportsData(selectedMonth);
                await loadManageEmployeesList();
            } catch (e) {
                console.error("Error loading employees: ", e);
                showModal('Error', 'Failed to load employee data.', ['OK']);
            }
        };

        const loadStoresForAddEmployee = async () => {
            try {
                const q = query(getCollectionRef('stores'));
                const querySnapshot = await getDocs(q);
                allStores = querySnapshot.docs.map(doc => doc.data());
                const select = document.getElementById('new-store');
                select.innerHTML = '<option value="">Select Store</option>';
                allStores.forEach(store => {
                    const option = document.createElement('option');
                    option.value = store.name;
                    option.textContent = store.name;
                    select.appendChild(option);
                });
            } catch (e) {
                console.error("Error loading stores: ", e);
            }
        };

        const loadDashboardData = async (date) => {
            try {
                const formattedDate = dayjs(date).format('YYYY-MM-DD');
                const attendanceRef = getCollectionRef('attendance');
                const attendanceQuery = query(attendanceRef, where('date', '==', formattedDate));

                const attendanceSnapshot = await getDocs(attendanceQuery);
                const attendanceRecords = attendanceSnapshot.docs.map(doc => doc.data());

                let filteredEmployees = allEmployees;
                if (showRelocatedOnly) {
                    filteredEmployees = allEmployees.filter(emp => emp.relocated);
                }

                const presentList = filteredEmployees.filter(emp => attendanceRecords.some(att => att.username === emp.username && att.status === 'Present'));
                const absentList = filteredEmployees.filter(emp => !attendanceRecords.some(att => att.username === emp.username));

                document.getElementById('totalEmployees').textContent = filteredEmployees.length;
                document.getElementById('presentEmployees').textContent = presentList.length;
                document.getElementById('absentEmployees').textContent = absentList.length;

                renderAttendanceList('present-list', presentList.map(emp => ({ ...emp, attendance: attendanceRecords.find(att => att.username === emp.username) })));
                renderAttendanceList('absent-list', absentList.map(emp => ({ ...emp, attendance: null })));
            } catch (e) {
                console.error("Error loading dashboard data: ", e);
                showModal('Error', 'Failed to load dashboard data.', ['OK']);
            }
        };

        const loadReportsData = async (month) => {
            try {
                const monthStart = dayjs(month).startOf('month').format('YYYY-MM-DD');
                const monthEnd = dayjs(month).endOf('month').format('YYYY-MM-DD');

                const attendanceRef = getCollectionRef('attendance');
                const attendanceQuery = query(attendanceRef, where('date', '>=', monthStart), where('date', '<=', monthEnd));
                const attendanceSnapshot = await getDocs(attendanceQuery);
                const attendanceRecords = attendanceSnapshot.docs.map(doc => doc.data());

                const employeeReportData = allEmployees.map(emp => {
                    const presentCount = attendanceRecords.filter(att => att.username === emp.username && att.status === 'Present').length;
                    const absentCount = attendanceRecords.filter(att => att.username === emp.username && att.status === 'Absent').length;
                    return {
                        username: emp.username,
                        name: emp.name,
                        relocated: emp.relocated ? 'Yes' : 'No',
                        presentCount,
                        absentCount
                    };
                });
                renderReportsTable(employeeReportData);
            } catch (e) {
                console.error("Error loading reports data: ", e);
                showModal('Error', 'Failed to load reports data.', ['OK']);
            }
        };

        const loadEmployeeHistoryData = async (month, username) => {
            if (!username) {
                document.getElementById('employee-history-table').innerHTML = '';
                return;
            }
            try {
                const monthStart = dayjs(month).startOf('month').format('YYYY-MM-DD');
                const monthEnd = dayjs(month).endOf('month').format('YYYY-MM-DD');

                const attendanceRef = getCollectionRef('attendance');
                const q = query(attendanceRef, where('username', '==', username), where('date', '>=', monthStart), where('date', '<=', monthEnd));
                const querySnapshot = await getDocs(q);
                const historyData = querySnapshot.docs.map(doc => doc.data());
                renderEmployeeHistoryTable(historyData);
            } catch (e) {
                console.error("Error loading employee history: ", e);
                showModal('Error', 'Failed to load employee history.', ['OK']);
            }
        };

        const loadManageEmployeesList = async () => {
            try {
                const employeeList = allEmployees.sort((a, b) => a.name.localeCompare(b.name));
                renderManageEmployeesTable(employeeList);
            } catch (e) {
                console.error("Error loading manage employees list: ", e);
                showModal('Error', 'Failed to load employee list.', ['OK']);
            }
        };

        const renderAttendanceList = (tableId, data) => {
            const tableBody = document.getElementById(tableId);
            tableBody.innerHTML = '';
            data.forEach(employee => {
                const row = document.createElement('tr');
                row.className = 'text-sm';
                let time = '';
                if (employee.attendance && employee.attendance.inTime) {
                    time = dayjs(employee.attendance.inTime).format('hh:mm A');
                }
                if (tableId === 'present-list') {
                    row.innerHTML = `
                        <td class="p-3">${employee.username}</td>
                        <td class="p-3">${employee.name}</td>
                        <td class="p-3">${employee.store}</td>
                    `;
                } else {
                    row.innerHTML = `
                        <td class="p-3">${employee.username}</td>
                        <td class="p-3">${employee.name}</td>
                    `;
                }
                tableBody.appendChild(row);
            });
        };

        const renderReportsTable = (data) => {
            const tableBody = document.getElementById('report-table');
            tableBody.innerHTML = '';
            data.forEach(employee => {
                const row = document.createElement('tr');
                row.className = 'text-sm';
                row.innerHTML = `
                    <td class="p-3">${employee.username}</td>
                    <td class="p-3">${employee.name}</td>
                    <td class="p-3">${employee.relocated}</td>
                    <td class="p-3 text-[var(--tally-green)] font-semibold">${employee.presentCount}</td>
                    <td class="p-3 text-[var(--tally-red)] font-semibold">${employee.absentCount}</td>
                `;
                tableBody.appendChild(row);
            });
        };

        const renderEmployeeHistoryTable = (data) => {
            const tableBody = document.getElementById('employee-history-table');
            tableBody.innerHTML = '';
            const sortedData = data.sort((a, b) => dayjs(a.date).isBefore(dayjs(b.date)) ? 1 : -1);
            sortedData.forEach(record => {
                const row = document.createElement('tr');
                row.className = 'text-sm';
                const statusClass = record.status === 'Present' ? 'text-[var(--tally-green)]' : 'text-[var(--tally-red)]';
                row.innerHTML = `
                    <td class="p-3">${dayjs(record.date).format('DD-MMM-YYYY')}</td>
                    <td class="p-3 font-semibold ${statusClass}">${record.status}</td>
                    <td class="p-3">${record.inTime ? dayjs(record.inTime).format('hh:mm A') : '-'}</td>
                    <td class="p-3">${record.outTime ? dayjs(record.outTime).format('hh:mm A') : '-'}</td>
                `;
                tableBody.appendChild(row);
            });
        };

        const renderManageEmployeesTable = (data) => {
            const tableBody = document.getElementById('manage-employee-list');
            tableBody.innerHTML = '';
            data.forEach(employee => {
                const statusClass = employee.status === 'Active' ? 'text-[var(--tally-green)]' : 'text-[var(--tally-red)]';
                const buttonText = employee.status === 'Active' ? 'Deactivate' : 'Activate';
                const row = document.createElement('tr');
                row.className = 'text-sm';
                row.innerHTML = `
                    <td class="p-3">${employee.username}</td>
                    <td class="p-3">${employee.name}</td>
                    <td class="p-3 font-semibold ${statusClass}">${employee.status}</td>
                    <td class="p-3">${employee.relocated ? 'Yes' : 'No'}</td>
                    <td class="p-3">
                        <button class="change-status-btn tally-btn-outline text-xs px-2 py-1"
                                data-username="${employee.username}"
                                data-name="${employee.name}"
                                data-current-status="${employee.status}">
                            ${buttonText}
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
        };

        // --- Event Handlers ---
        const handleNavigation = (event) => {
            event.preventDefault();
            const targetId = event.currentTarget.getAttribute('href').substring(1);

            sidebarItems.forEach(item => item.classList.remove('active'));
            event.currentTarget.classList.add('active');

            pageSections.forEach(section => {
                section.classList.add('hidden');
            });
            document.getElementById(targetId).classList.remove('hidden');
            pageTitle.textContent = event.currentTarget.textContent.trim();
        };

        const handleManualAttendance = async (event) => {
            event.preventDefault();
            const form = event.target;
            const username = form['employee-username'].value;
            const date = form['attendance-date'].value;
            const status = form['attendance-status'].value;
            const time = form['attendance-time'].value;
            const record = {
                username: username,
                date: date,
                status: status,
                inTime: time ? dayjs(`${date}T${time}`).toISOString() : null,
                outTime: null,
            };
            try {
                await addDoc(getCollectionRef('attendance'), record);
                showModal('Success', 'Attendance record saved successfully.', ['OK']);
                form.reset();
                await loadDashboardData(selectedDate);
            } catch (e) {
                console.error("Error adding document: ", e);
                showModal('Error', 'Failed to save attendance record.', ['OK']);
            }
        };

        const handleAddEmployee = async (event) => {
            event.preventDefault();
            const form = event.target;
            const username = form['new-username'].value;
            const name = form['new-name'].value;
            const store = form['new-store'].value;
            const status = form['new-status'].value;
            const relocated = form['new-relocated'].checked;

            const newEmployee = { username, name, store, status, relocated };
            try {
                await setDoc(doc(db, 'artifacts', appId, 'public', 'data', 'employees', username), newEmployee);
                showModal('Success', `${name} has been added as a new employee.`, ['OK']);
                form.reset();
                await loadEmployees(); // Reload all employee data
            } catch (e) {
                console.error("Error adding employee: ", e);
                showModal('Error', 'Failed to add new employee.', ['OK']);
            }
        };

        const updateEmployeeStatus = (username, name, currentStatus) => {
            const newStatus = currentStatus === 'Active' ? 'Inactive' : 'Active';
            showModal(
                'Confirm Status Change',
                `Are you sure you want to change the status of ${name} (${username}) to ${newStatus}?`,
                ['Cancel', 'Confirm'],
                async () => {
                    try {
                        const employeeDocRef = doc(db, 'artifacts', appId, 'public', 'data', 'employees', username);
                        await updateDoc(employeeDocRef, { status: newStatus });
                        showModal('Success', `Employee status updated to ${newStatus}.`, ['OK']);
                        await loadEmployees(); // Reload to reflect changes
                    } catch (e) {
                        console.error("Error updating employee status: ", e);
                        showModal('Error', 'Failed to update employee status.', ['OK']);
                    }
                }
            );
        };
        
        // --- PDF & Excel Generation ---
        const generateSummaryPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Daily Attendance Summary", 10, 10);
            doc.text(`Date: ${dayjs(selectedDate).format('DD-MMM-YYYY')}`, 10, 20);
            doc.text(`Total Employees: ${document.getElementById('totalEmployees').textContent}`, 10, 30);
            doc.text(`Present: ${document.getElementById('presentEmployees').textContent}`, 10, 40);
            doc.text(`Absent: ${document.getElementById('absentEmployees').textContent}`, 10, 50);
            doc.save("attendance_summary.pdf");
        };

        const generatePresentListPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const table = document.getElementById('present-list');
            doc.autoTable({
                head: [['ID', 'Name', 'Location']],
                body: Array.from(table.rows).map(row => Array.from(row.cells).map(cell => cell.textContent)),
                startY: 20
            });
            doc.text(`Present Employees List (${dayjs(selectedDate).format('DD-MMM-YYYY')})`, 10, 10);
            doc.save("present_employees.pdf");
        };
        
        const generateAbsentListPDF = () => {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const table = document.getElementById('absent-list');
            doc.autoTable({
                head: [['ID', 'Name']],
                body: Array.from(table.rows).map(row => Array.from(row.cells).map(cell => cell.textContent)),
                startY: 20
            });
            doc.text(`Absent Employees List (${dayjs(selectedDate).format('DD-MMM-YYYY')})`, 10, 10);
            doc.save("absent_employees.pdf");
        };

        const generateAttendanceSheet = (format) => {
            const data = [];
            const headers = ['Username', 'Name'];
            const datesInMonth = dayjs(selectedMonth).daysInMonth();
            for (let i = 1; i <= datesInMonth; i++) {
                headers.push(`${dayjs(selectedMonth).date(i).format('MMM D')}`);
            }
            data.push(headers);
        
            const monthlyAttendanceRef = getCollectionRef('monthly-attendance-reports');
            onSnapshot(query(monthlyAttendanceRef, where('month', '==', selectedMonth)), (querySnapshot) => {
                const attendanceData = {};
                querySnapshot.forEach(doc => {
                    const rec = doc.data();
                    if (!attendanceData[rec.username]) {
                        attendanceData[rec.username] = { name: rec.name, dates: {} };
                    }
                    attendanceData[rec.username].dates[dayjs(rec.date).format('YYYY-MM-DD')] = rec.status;
                });
        
                Object.keys(attendanceData).forEach(username => {
                    const row = [username, attendanceData[username].name];
                    for (let i = 1; i <= datesInMonth; i++) {
                        const date = dayjs(selectedMonth).date(i).format('YYYY-MM-DD');
                        row.push(attendanceData[username].dates[date] || 'N/A');
                    }
                    data.push(row);
                });
        
                const worksheet = XLSX.utils.aoa_to_sheet(data);
                const workbook = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(workbook, worksheet, "Attendance");
                XLSX.writeFile(workbook, `attendance_sheet_${selectedMonth}.${format}`);
            });
        };

        const exportAttendanceHistoryToExcel = async () => {
            const table = document.getElementById('employee-history-table');
            const data = [
                ['Date', 'Status', 'In Time', 'Out Time'],
                ...Array.from(table.rows).map(row => Array.from(row.cells).map(cell => cell.textContent))
            ];
            const worksheet = XLSX.utils.aoa_to_sheet(data);
            const workbook = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(workbook, worksheet, "Attendance History");
            XLSX.writeFile(workbook, `attendance_history_${selectedEmployeeUsername}_${selectedMonth}.xlsx`);
        };

        // --- Initial Setup and Listeners ---
        const loadEmployeeSelectOptions = () => {
            const select = document.getElementById('employee-select');
            select.innerHTML = '<option value="">Select Employee</option>';
            const sortedEmployees = allEmployees.sort((a, b) => a.name.localeCompare(b.name));
            sortedEmployees.forEach(emp => {
                const option = document.createElement('option');
                option.value = emp.username;
                option.textContent = `${emp.name} (${emp.username})`;
                select.appendChild(option);
            });
        };

        const initApp = () => {
            // Set initial dates
            const dateFilterInput = document.getElementById('date-filter');
            const monthFilterInput = document.getElementById('month-filter');
            const reportMonthFilter = document.getElementById('report-month-filter');
            dateFilterInput.value = dayjs().format('YYYY-MM-DD');
            monthFilterInput.value = dayjs().format('YYYY-MM');
            reportMonthFilter.value = dayjs().format('YYYY-MM');

            // Set up event listeners
            sidebarItems.forEach(item => item.addEventListener('click', handleNavigation));

            dateFilterInput.addEventListener('change', (e) => {
                selectedDate = e.target.value;
                loadDashboardData(selectedDate);
            });
            document.getElementById('show-relocated-only').addEventListener('change', (e) => {
                showRelocatedOnly = e.target.checked;
                loadDashboardData(selectedDate);
            });
            reportMonthFilter.addEventListener('change', (e) => {
                selectedMonth = e.target.value;
                loadReportsData(selectedMonth);
            });
            monthFilterInput.addEventListener('change', (e) => {
                selectedMonth = e.target.value;
                loadEmployeeHistoryData(selectedMonth, selectedEmployeeUsername);
            });
            document.getElementById('employee-select').addEventListener('change', (e) => {
                selectedEmployeeUsername = e.target.value;
                loadEmployeeHistoryData(selectedMonth, selectedEmployeeUsername);
            });
            document.getElementById('manual-attendance-form').addEventListener('submit', handleManualAttendance);
            document.getElementById('add-employee-form').addEventListener('submit', handleAddEmployee);
            document.getElementById('manage-employee-list').addEventListener('click', (event) => {
                const button = event.target.closest('.change-status-btn');
                if (button) {
                    const { username, name, currentStatus } = button.dataset;
                    updateEmployeeStatus(username, name, currentStatus);
                }
            });

            // PDF/Excel listeners
            document.getElementById('download-summary-pdf').addEventListener('click', generateSummaryPDF);
            document.getElementById('download-present-pdf').addEventListener('click', generatePresentListPDF);
            document.getElementById('download-absent-pdf').addEventListener('click', generateAbsentListPDF);
            document.getElementById('download-attendance-sheet-excel').addEventListener('click', () => generateAttendanceSheet('xlsx'));
            document.getElementById('export-history-excel').addEventListener('click', exportAttendanceHistoryToExcel);

            // Load initial data
            loadStoresForAddEmployee();
            loadEmployees();
        };

        // Start the application
        setupFirebase();
    </script>
</body>
</html>
