<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PB Escalation Matrix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Simple modal styles */
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 50;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
        }
        /* Custom scrollbar for ticket tables - Hiding the scrollbar */
        .table-container {
            /* For Firefox */
            scrollbar-width: none;
            /* For Internet Explorer and Edge */
            -ms-overflow-style: none;
        }
        .table-container::-webkit-scrollbar {
            display: none; /* Hide scrollbar for Chrome, Safari, and Opera */
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto">

        <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-lg">
                <div class="flex justify-center mb-6">
                    <img src="logo1.png" alt="Logo" class="h-12 w-auto" onerror="this.style.display='none';">
                </div>
                <h1 class="text-3xl font-bold text-center text-gray-700 mb-2">Welcome Back</h1>
                <p class="text-center text-gray-500 mb-6">Please login to your account</p>
                <div id="login-error" class="text-red-500 text-sm mb-4 text-center"></div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-600 mb-1">Username</label>
                        <input type="text" id="username" name="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
                        <input type="password" id="password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105">Login</button>
                </form>
            </div>
        </div>

        <div id="main-content" class="hidden">
            <header class="bg-white shadow-md p-4 flex justify-between items-center rounded-b-lg sticky top-0 z-10">
                <div class="flex items-center">
                    <img src="logo1.png" alt="Logo" class="h-8 w-auto mr-3" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <svg class="h-8 w-8 text-indigo-600 mr-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-12v.75m0 3v.75m0 3v.75m0 3V18m-3-12v.75m0 3v.75m0 3v.75m0 3V18m12-12h-3.375a4.125 4.125 0 00-4.125 4.125v1.5c0 .621.504 1.125 1.125 1.125H9.75v-1.5a2.625 2.625 0 012.625-2.625h3.375z" />
                    </svg>
                    <h1 class="text-xl font-bold text-indigo-600">PB EM</h1>
                </div>
                <div class="flex items-center">
                    <span id="welcome-user" class="text-gray-600 mr-4"></span>
                    <button id="logout-btn" class="bg-red-500 text-white text-sm font-medium py-2 px-4 rounded-lg hover:bg-red-600 transition">Logout</button>
                </div>
            </header>

            <main class="p-4 space-y-8 pb-24">
                <div id="raise-ticket" class="tab-content bg-white p-6 rounded-lg shadow-md">
                    <form id="ticket-form" class="space-y-4">
                        <div>
                            <label for="store-name" class="block text-sm font-medium text-gray-700">Store Name</label>
                            <input type="text" id="store-name" class="mt-1 block w-full bg-gray-100 p-2 border border-gray-300 rounded-md shadow-sm" readonly>
                        </div>
                        <div>
                            <label for="person-name" class="block text-sm font-medium text-gray-700">Person Name</label>
                            <input type="text" id="person-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label for="issue-type" class="block text-sm font-medium text-gray-700">Issue Type</label>
                            <select id="issue-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="">-- Select Issue Type --</option>
                            </select>
                        </div>
                        <div>
                            <label for="department" class="block text-sm font-medium text-gray-700">Department</label>
                            <input type="text" id="department" class="mt-1 block w-full bg-gray-100 p-2 border border-gray-300 rounded-md shadow-sm" readonly>
                        </div>
                         <div>
                            <label for="authorized-person" class="block text-sm font-medium text-gray-700">Authorized Person</to></label>
                            <select id="authorized-person" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="">-- Select Authorized Person --</option>
                            </select>
                        </div>
                        <div>
                            <label for="issue-details" class="block text-sm font-medium text-gray-700">Issue Details (Max 300 characters)</label>
                            <textarea id="issue-details" rows="4" maxlength="300" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                            <p id="char-count" class="text-right text-sm text-gray-500">0 / 300</p>
                        </div>
                        <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">Submit Ticket</button>
                    </form>
                </div>

                <div id="ticket-status" class="tab-content hidden space-y-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Active Tickets</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md overflow-hidden">
                           <div class="table-container overflow-x-auto">
                                <table class="w-full min-w-max text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Issue Date</th>
                                            <th scope="col" class="px-6 py-3">Store</th>
                                            <th scope="col" class="px-6 py-3">Person</th>
                                            <th scope="col" class="px-6 py-3">Issue Type</th>
                                            <th scope="col" class="px-6 py-3">Department</th>
                                            <th scope="col" class="px-6 py-3">Authorized</th>
                                            <th scope="col" class="px-6 py-3">Details</th>
                                            <th scope="col" class="px-6 py-3">Status</th>
                                            <th scope="col" class="px-6 py-3">Update</th>
                                        </tr>
                                    </thead>
                                    <tbody id="active-tickets-body">
                                        </tbody>
                                </table>
                           </div>
                            <p id="no-active-tickets" class="text-center py-4 text-gray-500 hidden">No active tickets found.</p>
                        </div>
                    </div>
                     <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Closed Tickets</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md overflow-hidden">
                             <div class="table-container overflow-x-auto">
                                <table class="w-full min-w-max text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Close Date</th>
                                            <th scope="col" class="px-6 py-3">Issue Date</th>
                                            <th scope="col" class="px-6 py-3">Store</th>
                                            <th scope="col" class="px-6 py-3">Person</th>
                                            <th scope="col" class="px-6 py-3">Issue Type</th>
                                            <th scope="col" class="px-6 py-3">Department</th>
                                            <th scope="col" class="px-6 py-3">Authorized</th>
                                            <th scope="col" class="px-6 py-3">Details</th>
                                            <th scope="col" class="px-6 py-3">Status</th>
                                            <th scope="col" class="px-6 py-3">Final Update</th>
                                        </tr>
                                    </thead>
                                    <tbody id="closed-tickets-body">
                                        </tbody>
                                </table>
                             </div>
                            <p id="no-closed-tickets" class="text-center py-4 text-gray-500 hidden">No closed tickets found.</p>
                        </div>
                    </div>
                </div>

                <div id="notice-board" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-700">Notifications</h2>
                    <div id="notifications-container" class="space-y-4">
                        </div>
                     <p id="no-notifications" class="text-center py-4 text-gray-500 hidden">No new notifications.</p>
                </div>
            </main>
        </div>
    </div>
    
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_5px_rgba(0,0,0,0.1)] z-20 hidden">
        <div class="max-w-4xl mx-auto flex justify-around">
            <button data-tab="raise-ticket" class="tab-btn flex-1 flex flex-col items-center justify-center pt-3 pb-2 text-center font-semibold text-indigo-600">
                 <svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M12 9v6m3-3H9m12 0a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                <span class="text-xs">Raise Ticket</span>
            </button>
            <button data-tab="ticket-status" class="tab-btn flex-1 flex flex-col items-center justify-center pt-3 pb-2 text-center font-semibold text-gray-500">
                <svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-1.125 0-2.25.9-2.25 2.25v11.25c0 1.24 1.01 2.25 2.25 2.25h9.75c1.24 0 2.25-1.01 2.25-2.25V13.5m-8.25 0h1.5m-1.5 0l-3.75 3.75m3.75-3.75L1.5 15m3.75-3.75h.008v.008H5.25v-.008z" /></svg>
                <span class="text-xs">Status</span>
            </button>
            <button data-tab="notice-board" class="tab-btn flex-1 flex flex-col items-center justify-center pt-3 pb-2 text-center font-semibold text-gray-500">
                 <svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
                <span class="text-xs">Notices</span>
            </button>
        </div>
    </nav>
    
    <div id="remark-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Add Remark</h3>
            <textarea id="remark-textarea" rows="3" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter your remark..."></textarea>
            <p id="remark-error" class="text-red-500 text-sm mt-2 h-5"></p>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="cancel-remark-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="submit-remark-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 w-20 text-center">OK</button>
            </div>
        </div>
    </div>

    <div id="ticket-details-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Ticket Details</h3>
                <button id="close-details-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="ticket-details-content" class="space-y-2 text-sm">
                </div>
            <div class="mt-5 text-right">
                 <button id="close-details-modal-btn-bottom" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Close</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- SUPABASE CLIENT SETUP ---
        // IMPORTANT: Replace with your actual Supabase URL and Anon Key

        const SUPABASE_URL = 'https://dfepjaivpgomxsjbxnhz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmZXBqYWl2cGdvbXhzamJ4bmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MjY0NTMsImV4cCI6MjA2NTQwMjQ1M30.5ASDRBIH0CQ-4d2_1g8hfsZlotOp1EbU9v9nZXZdRIM';


        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            const mainContent = document.getElementById('app');
            mainContent.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert">
                      <p class="font-bold">Configuration Needed</p>
                      <p>Please update the <code>SUPABASE_URL</code> and <code>SUPABASE_ANON_KEY</code> variables in the script section of this HTML file.</p>
                    </div>
                </div>
            `;
            throw new Error("Supabase credentials are not set.");
        }
        
        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let issueTypesCache = [];

        // --- DOM ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const welcomeUserEl = document.getElementById('welcome-user');
        const bottomNav = document.getElementById('bottom-nav');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const ticketForm = document.getElementById('ticket-form');
        const issueDetailsTextarea = document.getElementById('issue-details');
        const charCountEl = document.getElementById('char-count');
        
        // --- AUTHENTICATION ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            loginError.textContent = '';

            const { data, error } = await dbClient
                .from('store_users')
                .select('*')
                .eq('user_name', username)
                .eq('password', password)
                .single();

            if (error || !data) {
                loginError.textContent = 'Invalid username or password.';
                return;
            }

            currentUser = data;
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            initializeApp();
        });

        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            loginScreen.style.display = 'flex';
            mainContent.style.display = 'none';
            bottomNav.style.display = 'none';
            loginForm.reset();
        });

        function checkSession() {
            const user = sessionStorage.getItem('currentUser');
            if (user) {
                currentUser = JSON.parse(user);
                initializeApp();
            }
        }
        
        // --- INITIALIZATION ---
        async function initializeApp() {
            loginScreen.style.display = 'none';
            mainContent.style.display = 'block';
            bottomNav.style.display = 'block';
            welcomeUserEl.textContent = `Welcome, ${currentUser
