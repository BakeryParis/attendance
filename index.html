<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PB Escalation Matrix</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .modal-backdrop {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            z-index: 50;
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 0.5rem;
            width: 90%;
            max-width: 500px;
        }
        .table-container {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .table-container::-webkit-scrollbar {
            display: none;
        }
        .notification-bubble {
            position: absolute;
            top: 8px;
            right: 20px;
            min-width: 20px;
            height: 20px;
            background: #ef4444;
            color: white;
            border-radius: 9999px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: bold;
            line-height: 1;
            z-index: 100;
            border: 2px solid white;
            pointer-events: none;
        }
        #image-preview {
            max-height: 150px;
            border-radius: 0.5rem;
            border: 1px solid #e5e7eb;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-4xl mx-auto">

        <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-sm bg-white p-8 rounded-xl shadow-lg">
                <div class="flex justify-center mb-6">
                    <img src="logo1.png" alt="Logo" class="h-12 w-auto" onerror="this.style.display='none';">
                </div>
                <h1 class="text-3xl font-bold text-center text-gray-700 mb-2">Escalation Matrix</h1>
                <p class="text-center text-gray-500 mb-6">Please login to your account</p>
                <div id="login-error" class="text-red-500 text-sm mb-4 text-center"></div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="username" class="block text-sm font-medium text-gray-600 mb-1">Username</label>
                        <input type="text" id="username" name="username" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
                        <input type="password" id="password" name="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition transform hover:scale-105">Login</button>
                </form>
            </div>
        </div>

        <div id="main-content" class="hidden">
            <header class="bg-white shadow-md p-4 flex justify-between items-center rounded-b-lg sticky top-0 z-10">
                <div class="flex items-center">
                    <img src="logo1.png" alt="Logo" class="h-8 w-auto mr-3" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
                    <svg class="h-8 w-8 text-indigo-600 mr-2 hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-12v.75m0 3v.75m0 3v.75m0 3V18m-3-12v.75m0 3v.75m0 3v.75m0 3V18m12-12h-3.375a4.125 4.125 0 00-4.125 4.125v1.5c0 .621.504 1.125 1.125 1.125H9.75v-1.5a2.625 2.625 0 012.625-2.625h3.375z" />
                    </svg>
                    <h1 class="text-xl font-bold text-indigo-600">PB EM</h1>
                </div>
                <div class="flex items-center">
                    <span id="welcome-user" class="text-gray-600 mr-4"></span>
                    <button id="logout-btn" class="bg-red-500 text-white text-sm font-medium py-2 px-4 rounded-lg hover:bg-red-600 transition">Logout</button>
                </div>
            </header>

            <main class="p-4 space-y-8 pb-24">
                <div id="raise-ticket" class="tab-content bg-white p-6 rounded-lg shadow-md">
                    <form id="ticket-form" class="space-y-4">
                        <div>
                            <label for="store-name" class="block text-sm font-medium text-gray-700">Store Name</label>
                            <input type="text" id="store-name" class="mt-1 block w-full bg-gray-100 p-2 border border-gray-300 rounded-md shadow-sm" readonly>
                        </div>
                        <div>
                            <label for="person-name" class="block text-sm font-medium text-gray-700">Person Name</label>
                            <input type="text" id="person-name" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                        </div>
                        <div>
                            <label for="issue-type" class="block text-sm font-medium text-gray-700">Issue Type</label>
                            <select id="issue-type" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="">-- Select Issue Type --</option>
                            </select>
                        </div>
                        <div>
                            <label for="department" class="block text-sm font-medium text-gray-700">Department</label>
                            <input type="text" id="department" class="mt-1 block w-full bg-gray-100 p-2 border border-gray-300 rounded-md shadow-sm" readonly>
                        </div>
                         <div>
                            <label for="authorized-person" class="block text-sm font-medium text-gray-700">Authorized Person</label>
                            <select id="authorized-person" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required>
                                <option value="">-- Select Issue Type First --</option>
                            </select>
                        </div>
                        <div>
                            <label for="issue-details" class="block text-sm font-medium text-gray-700">Issue Details (Max 300 characters)</label>
                            <textarea id="issue-details" rows="4" maxlength="300" class="mt-1 block w-full p-2 border border-gray-300 rounded-md shadow-sm focus:ring-indigo-500 focus:border-indigo-500" required></textarea>
                            <p id="char-count" class="text-right text-sm text-gray-500">0 / 300</p>
                        </div>
                        
                        <div>
                            <label for="issue-file" class="block text-sm font-medium text-gray-700">Attach File (Optional, Max 10MB)</label>
                            <input type="file" id="issue-file" class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-600 hover:file:bg-indigo-100">
                            <div id="file-preview-container" class="mt-2 hidden">
                                <img id="image-preview" src="#" alt="Image Preview" class="hidden mt-2"/>
                                <div id="generic-file-preview" class="hidden flex items-center bg-gray-100 p-2 rounded-md mt-2">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-gray-500 mr-3 flex-shrink-0" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>
                                    <span id="file-name-display" class="text-sm text-gray-800 font-semibold truncate"></span>
                                </div>
                                <button type="button" id="remove-file-btn" class="mt-1 text-xs text-red-600 hover:text-red-800">Remove File</button>
                            </div>
                        </div>

                        <button type="submit" id="submit-ticket-btn" class="w-full bg-indigo-600 text-white font-semibold py-2 px-4 rounded-lg hover:bg-indigo-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-indigo-500 transition">Submit Ticket</button>
                    </form>
                </div>

                <div id="ticket-status" class="tab-content hidden space-y-8">
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Active Tickets</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md overflow-hidden">
                           <div class="table-container overflow-x-auto">
                                <table class="w-full min-w-max text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Issue Date</th>
                                            <th scope="col" class="px-6 py-3">Store</th>
                                            <th scope="col" class="px-6 py-3">Person</th>
                                            <th scope="col" class="px-6 py-3">Issue Type</th>
                                            <th scope="col" class="px-6 py-3">Department</th>
                                            <th scope="col" class="px-6 py-3">Authorized</th>
                                            <th scope="col" class="px-6 py-3">Details</th>
                                            <th scope="col" class="px-6 py-3">Status</th>
                                            <th scope="col" class="px-6 py-3">Update</th>
                                        </tr>
                                    </thead>
                                    <tbody id="active-tickets-body">
                                        </tbody>
                                </table>
                           </div>
                            <p id="no-active-tickets" class="text-center py-4 text-gray-500 hidden">No active tickets found.</p>
                        </div>
                    </div>
                     <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Closed Tickets</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md overflow-hidden">
                             <div class="table-container overflow-x-auto">
                                <table class="w-full min-w-max text-sm text-left text-gray-500">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th scope="col" class="px-6 py-3">Close Date</th>
                                            <th scope="col" class="px-6 py-3">Issue Date</th>
                                            <th scope="col" class="px-6 py-3">Store</th>
                                            <th scope="col" class="px-6 py-3">Person</th>
                                            <th scope="col" class="px-6 py-3">Issue Type</th>
                                            <th scope="col" class="px-6 py-3">Department</th>
                                            <th scope="col" class="px-6 py-3">Authorized</th>
                                            <th scope="col" class="px-6 py-3">Details</th>
                                            <th scope="col" class="px-6 py-3">Status</th>
                                            <th scope="col" class="px-6 py-3">Final Update</th>
                                        </tr>
                                    </thead>
                                    <tbody id="closed-tickets-body">
                                        </tbody>
                                </table>
                             </div>
                            <p id="no-closed-tickets" class="text-center py-4 text-gray-500 hidden">No closed tickets found.</p>
                        </div>
                    </div>
                </div>

                <div id="notice-board" class="tab-content hidden">
                    <h2 class="text-2xl font-bold mb-4 text-gray-700">Notifications</h2>
                    <div id="notifications-container" class="space-y-4">
                        </div>
                     <p id="no-notifications" class="text-center py-4 text-gray-500 hidden">No new notifications.</p>
                </div>
            </main>
        </div>
    </div>
    
    <nav id="bottom-nav" class="fixed bottom-0 left-0 right-0 bg-white shadow-[0_-2px_5px_rgba(0,0,0,0.1)] z-20 hidden">
        <div class="max-w-4xl mx-auto flex justify-around">
            <button data-tab="raise-ticket" class="tab-btn flex-1 flex flex-col items-center justify-center pt-3 pb-2 text-center font-semibold text-indigo-600">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 6v.75m0 3v.75m0 3v.75m0 3V18m-9-5.25h5.25M7.5 15h3M3.375 5.25c-.621 0-1.125.504-1.125 1.125v3.026a2.999 2.999 0 0 1 0 5.198v3.026c0 .621.504 1.125 1.125 1.125h17.25c.621 0 1.125-.504 1.125-1.125v-3.026a2.999 2.999 0 0 1 0-5.198V6.375c0-.621-.504-1.125-1.125-1.125H3.375Z" />
</svg>

                <span class="text-xs">Raise Ticket</span>
            </button>
            <button data-tab="ticket-status" class="tab-btn flex-1 flex flex-col items-center justify-center pt-3 pb-2 text-center font-semibold text-gray-500">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="size-6">
  <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 6.75h12M8.25 12h12m-12 5.25h12M3.75 6.75h.007v.008H3.75V6.75Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0ZM3.75 12h.007v.008H3.75V12Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Zm-.375 5.25h.007v.008H3.75v-.008Zm.375 0a.375.375 0 1 1-.75 0 .375.375 0 0 1 .75 0Z" />
</svg><span class="text-xs">Status</span>
            </button>
            <div class="relative flex-1 flex flex-col items-center justify-center pt-3 pb-2 text-center font-semibold">
                <button data-tab="notice-board" class="tab-btn flex flex-col items-center justify-center text-gray-500 w-full">
                     <svg class="w-6 h-6 mb-1" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M14.857 17.082a23.848 23.848 0 005.454-1.31A8.967 8.967 0 0118 9.75v-.7V9A6 6 0 006 9v.75a8.967 8.967 0 01-2.312 6.022c1.733.64 3.56 1.085 5.455 1.31m5.714 0a24.255 24.255 0 01-5.714 0m5.714 0a3 3 0 11-5.714 0" /></svg>
                    <span class="text-xs">Notices</span>
                </button>
                <span id="notification-bubble" class="notification-bubble hidden"></span>
            </div>
        </div>
    </nav>
    
    <audio id="notification-sound" src="https://cdn.freesound.org/previews/219/219244_401265-lq.mp3" preload="auto"></audio>

    <div id="remark-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Write Reply</h3>
            <textarea id="remark-textarea" rows="3" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter your message..."></textarea>
            <p id="remark-error" class="text-red-500 text-sm mt-2 h-5"></p>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="cancel-remark-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="submit-remark-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700 w-20 text-center">Reply</button>
            </div>
        </div>
    </div>

    <div id="reopen-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 class="text-lg font-medium leading-6 text-gray-900 mb-4">Re-open Ticket</h3>
            <p class="text-sm text-gray-600 mb-3">Please provide a reason for re-opening this ticket.</p>
            <textarea id="reopen-reason-textarea" rows="3" class="w-full p-2 border border-gray-300 rounded-md" placeholder="Enter reason here..."></textarea>
            <p id="reopen-error" class="text-red-500 text-sm mt-2 h-5"></p>
            <div class="mt-4 flex justify-end space-x-2">
                <button id="cancel-reopen-btn" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-md hover:bg-gray-300">Cancel</button>
                <button id="submit-reopen-btn" class="px-4 py-2 bg-yellow-500 text-white rounded-md hover:bg-yellow-600 w-28 text-center">Re-open</button>
            </div>
        </div>
    </div>

    <div id="ticket-details-modal" class="modal-backdrop">
        <div class="modal-content">
            <div class="flex justify-between items-center mb-2">
                <h3 class="text-lg font-medium leading-6 text-gray-900">Ticket Details</h3>
                <button id="close-details-modal-btn" class="text-gray-400 hover:text-gray-600">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
            </div>
            <div id="ticket-details-actions" class="mb-4"></div>
            <div id="ticket-details-content" class="space-y-2 text-sm">
            </div>
            <div class="mt-5 text-right space-x-2">
                 <button id="close-details-modal-btn-bottom" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">Close</button>
            </div>
        </div>
    </div>

    <div id="alert-modal" class="modal-backdrop">
        <div class="modal-content">
            <h3 id="alert-modal-title" class="text-lg font-medium leading-6 text-gray-900 mb-4"></h3>
            <p id="alert-modal-message" class="text-sm text-gray-600"></p>
            <div class="mt-5 text-right">
                 <button id="close-alert-modal-btn" class="px-4 py-2 bg-indigo-600 text-white rounded-md hover:bg-indigo-700">OK</button>
            </div>
        </div>
    </div>


    <script type="module">
        // --- SUPABASE CLIENT SETUP ---
        const SUPABASE_URL = 'https://dfepjaivpgomxsjbxnhz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmZXBqYWl2cGdvbXhzamJ4bmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MjY0NTMsImV4cCI6MjA2NTQwMjQ1M30.5ASDRBIH0CQ-4d2_1g8hfsZlotOp1EbU9v9nZXZdRIM';
        
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            const mainContent = document.getElementById('app');
            mainContent.innerHTML = `
                <div class="min-h-screen flex items-center justify-center p-4">
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 rounded-lg" role="alert">
                      <p class="font-bold">Configuration Needed</p>
                      <p>Please update the <code>SUPABASE_URL</code> and <code>SUPABASE_ANON_KEY</code> variables in the script section of this HTML file.</p>
                    </div>
                </div>
            `;
            throw new Error("Supabase credentials are not set.");
        }
        
        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        // --- STATE MANAGEMENT ---
        let currentUser = null;
        let issueTypesCache = [];
        let afterAlertAction = null; 
        let currentNotificationCount = 0;
        let isInitialNotifCheck = true;
        let currentTicketToReopen = null;

        // --- DOM ELEMENTS ---
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const welcomeUserEl = document.getElementById('welcome-user');
        const bottomNav = document.getElementById('bottom-nav');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');
        const ticketForm = document.getElementById('ticket-form');
        const issueDetailsTextarea = document.getElementById('issue-details');
        const charCountEl = document.getElementById('char-count');
        const notificationBubble = document.getElementById('notification-bubble');
        const alertModal = document.getElementById('alert-modal');
        const alertModalTitle = document.getElementById('alert-modal-title');
        const alertModalMessage = document.getElementById('alert-modal-message');
        const closeAlertModalBtn = document.getElementById('close-alert-modal-btn');
        const reopenModal = document.getElementById('reopen-modal');
        const cancelReopenBtn = document.getElementById('cancel-reopen-btn');
        const submitReopenBtn = document.getElementById('submit-reopen-btn');
        const reopenReasonTextarea = document.getElementById('reopen-reason-textarea');
        const reopenErrorEl = document.getElementById('reopen-error');
        // CHANGED: Elements for conditional file preview
        const issueFileInput = document.getElementById('issue-file');
        const filePreviewContainer = document.getElementById('file-preview-container');
        const imagePreview = document.getElementById('image-preview');
        const genericFilePreview = document.getElementById('generic-file-preview');
        const fileNameDisplay = document.getElementById('file-name-display');
        const removeFileBtn = document.getElementById('remove-file-btn');
        
        // --- AUTHENTICATION ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const username = loginForm.username.value;
            const password = loginForm.password.value;
            loginError.textContent = '';

            const { data, error } = await dbClient
                .from('store_users')
                .select('*')
                .eq('user_name', username)
                .eq('password', password)
                .single();

            if (error || !data) {
                loginError.textContent = 'Invalid username or password.';
                return;
            }

            currentUser = data;
            sessionStorage.setItem('currentUser', JSON.stringify(currentUser));
            initializeApp();
        });

        logoutBtn.addEventListener('click', () => {
            currentUser = null;
            sessionStorage.removeItem('currentUser');
            isInitialNotifCheck = true; 
            loginScreen.style.display = 'flex';
            mainContent.style.display = 'none';
            bottomNav.style.display = 'none';
            loginForm.reset();
        });

        function checkSession() {
            const user = sessionStorage.getItem('currentUser');
            if (user) {
                currentUser = JSON.parse(user);
                initializeApp();
            }
        }
        
        // --- INITIALIZATION ---
        async function initializeApp() {
            loginScreen.style.display = 'none';
            mainContent.style.display = 'block';
            bottomNav.style.display = 'block';
            welcomeUserEl.textContent = `Welcome, ${currentUser.store}`; 
            document.getElementById('store-name').value = currentUser.store;
            
            await populateDropdowns();
            updateNotificationBubble();
            document.querySelector('[data-tab="raise-ticket"]').click();
        }

        // --- TAB NAVIGATION ---
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.dataset.tab;
                tabBtns.forEach(b => {
                    b.classList.remove('text-indigo-600', 'border-indigo-500');
                    b.classList.add('text-gray-500', 'border-transparent');
                });
                btn.classList.add('text-indigo-600', 'border-indigo-500');
                btn.classList.remove('text-gray-500', 'border-transparent');
                tabContents.forEach(content => content.style.display = content.id === targetTab ? 'block' : 'none');

                if (targetTab === 'ticket-status') fetchTickets();
                if (targetTab === 'notice-board') fetchNotifications();
            });
        });

        // --- CUSTOM ALERT MODAL LOGIC ---
        function showCustomAlert(title, message, isSuccess = true, customAction = null) {
            alertModalTitle.textContent = title;
            alertModalMessage.textContent = message;
            alertModalTitle.className = isSuccess 
                ? 'text-lg font-medium leading-6 text-green-700 mb-4' 
                : 'text-lg font-medium leading-6 text-red-700 mb-4';
            
            afterAlertAction = customAction;
            
            if (isSuccess && title === 'Success!' && !customAction) {
                 afterAlertAction = () => {
                    ticketForm.reset();
                    charCountEl.textContent = '0 / 300';
                    document.getElementById('store-name').value = currentUser.store;
                    document.getElementById('authorized-person').innerHTML = '<option value="">-- Select Issue Type First --</option>';
                    filePreviewContainer.classList.add('hidden');
                    issueFileInput.value = '';
                    document.querySelector('[data-tab="ticket-status"]').click();
                };
            }
            alertModal.style.display = 'flex';
        }

        closeAlertModalBtn.addEventListener('click', () => {
            alertModal.style.display = 'none';
            if (typeof afterAlertAction === 'function') {
                afterAlertAction();
                afterAlertAction = null;
            }
        });
        
        // --- RAISE TICKET SECTION ---
        async function populateDropdowns() {
            const { data: issues, error: issueError } = await dbClient.from('issue_types').select('*');
            if (issueError) {
                console.error('Error fetching issue types:', issueError);
                return;
            }
            issueTypesCache = issues;
            const issueTypeSelect = document.getElementById('issue-type');
            issueTypeSelect.innerHTML = '<option value="">-- Select Issue Type --</option>';
            issues.forEach(issue => {
                const option = document.createElement('option');
                option.value = issue.issue_type;
                option.textContent = issue.issue_type;
                issueTypeSelect.appendChild(option);
            });
        }
        
        document.getElementById('issue-type').addEventListener('change', (e) => {
            const selectedType = e.target.value;
            const departmentInput = document.getElementById('department');
            const authorizedSelect = document.getElementById('authorized-person');

            departmentInput.value = '';
            authorizedSelect.innerHTML = '<option value="">-- Select Authorized Person --</option>';
            
            if (selectedType) {
                const issue = issueTypesCache.find(it => it.issue_type === selectedType);
                if (issue) {
                    departmentInput.value = issue.department || '';
                    const contacts = [issue.contact_1, issue.contact_2, issue.contact_3, issue.contact_4].filter(Boolean);
                    
                    if (contacts.length === 0) {
                         authorizedSelect.innerHTML = '<option value="">-- No contacts available --</option>';
                    } else {
                        contacts.forEach(person => {
                            const option = document.createElement('option');
                            option.value = person;
                            option.textContent = person;
                            authorizedSelect.appendChild(option);
                        });
                    }
                }
            } else {
                 authorizedSelect.innerHTML = '<option value="">-- Select Issue Type First --</option>';
            }
        });

        issueDetailsTextarea.addEventListener('input', () => {
            const count = issueDetailsTextarea.value.length;
            charCountEl.textContent = `${count} / 300`;
        });
        
        // CHANGED: Event listener for conditional file preview
        issueFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                 if (file.size > 10 * 1024 * 1024) { // 10MB limit
                    showCustomAlert('File Too Large', 'Please select a file smaller than 10MB.', false);
                    issueFileInput.value = '';
                    return;
                }

                // Show the main preview container
                filePreviewContainer.classList.remove('hidden');

                // Check if the file is an image
                if (file.type.startsWith('image/')) {
                    genericFilePreview.classList.add('hidden');
                    imagePreview.classList.remove('hidden');
                    const reader = new FileReader();
                    reader.onload = function(event) {
                        imagePreview.src = event.target.result;
                    }
                    reader.readAsDataURL(file);
                } else {
                    // It's not an image, show generic preview
                    imagePreview.classList.add('hidden');
                    genericFilePreview.classList.remove('hidden');
                    fileNameDisplay.textContent = file.name;
                }
            }
        });

        removeFileBtn.addEventListener('click', () => {
            issueFileInput.value = '';
            filePreviewContainer.classList.add('hidden');
            imagePreview.src = '#';
            fileNameDisplay.textContent = '';
        });

        // This function now handles any file type but uses the original bucket/column names
        ticketForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const submitBtn = document.getElementById('submit-ticket-btn');
            submitBtn.disabled = true;
            submitBtn.textContent = 'Submitting...';

            let fileUrl = null;
            const file = issueFileInput.files[0];

            if (file) {
                const fileName = `${currentUser.store}_${Date.now()}_${file.name}`;
                const { error: uploadError } = await dbClient.storage
                    .from('ticket-images') // Using original bucket name
                    .upload(fileName, file);

                if (uploadError) {
                    showCustomAlert('Upload Failed', 'Error uploading file: ' + uploadError.message, false);
                    submitBtn.disabled = false;
                    submitBtn.textContent = 'Submit Ticket';
                    return;
                }

                const { data: urlData } = dbClient.storage
                    .from('ticket-images') // Using original bucket name
                    .getPublicUrl(fileName);
                fileUrl = urlData.publicUrl;
            }
            
            const newTicket = {
                store_name: document.getElementById('store-name').value,
                person_name: document.getElementById('person-name').value,
                issue_type: document.getElementById('issue-type').value,
                department: document.getElementById('department').value,
                authorized: document.getElementById('authorized-person').value,
                issue_details: document.getElementById('issue-details').value,
                issue_status: 'PENDING',
                action_update: 'Ticket raised successfully.',
                issue_date: new Date().toISOString(),
                image_url: fileUrl, // Using original column name
            };

            const { data, error } = await dbClient.from('tickets').insert([newTicket]).select();
            
            submitBtn.disabled = false;
            submitBtn.textContent = 'Submit Ticket';

            if (error) {
                showCustomAlert('Submission Failed', 'Error: ' + error.message, false);
                console.error('Ticket submission error:', error);
            } else {
                showCustomAlert('Success!', 'Your ticket has been submitted successfully.', true);
            }
        });

        // --- TICKET STATUS SECTION ---
        async function fetchTickets() {
            const { data, error } = await dbClient
                .from('tickets')
                .select('*')
                .eq('store_name', currentUser.store)
                .order('issue_date', { ascending: false });

            if (error) {
                console.error('Error fetching tickets:', error);
                return;
            }

            const activeTickets = data.filter(t => ['PENDING', 'ACCEPTED', 'REVIEWED', 'UNDER PROCESS'].includes(t.issue_status));
            const closedTickets = data.filter(t => t.issue_status === 'COMPLETED');
            
            renderTickets('active-tickets-body', activeTickets, 'no-active-tickets', 'active');
            renderTickets('closed-tickets-body', closedTickets, 'no-closed-tickets', 'closed');
        }

        function renderTickets(tbodyId, tickets, noDataElId, type) {
            const tbody = document.getElementById(tbodyId);
            const noDataEl = document.getElementById(noDataElId);
            tbody.innerHTML = '';
            
            if(tickets.length === 0) {
                noDataEl.style.display = 'block';
                return;
            }
            noDataEl.style.display = 'none';

            tickets.forEach(ticket => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b hover:bg-gray-50 cursor-pointer';
                tr.setAttribute('data-ticket', JSON.stringify(ticket));
                
                let dateColumns = '';
                const issueDateFormatted = ticket.issue_date ? new Date(ticket.issue_date).toLocaleDateString() : 'N/A';
                
                if (type === 'active') {
                    dateColumns = `<td class="px-6 py-4 whitespace-nowrap">${issueDateFormatted}</td>`;
                } else {
                    const closeDateFormatted = ticket.issue_close_dt ? new Date(ticket.issue_close_dt).toLocaleDateString() : 'N/A';
                    dateColumns = `
                        <td class="px-6 py-4 whitespace-nowrap">${closeDateFormatted}</td>
                        <td class="px-6 py-4 whitespace-nowrap">${issueDateFormatted}</td>
                    `;
                }

                tr.innerHTML = `
                    ${dateColumns}
                    <td class="px-6 py-4">${ticket.store_name}</td>
                    <td class="px-6 py-4">${ticket.person_name}</td>
                    <td class="px-6 py-4 font-medium text-gray-900">${ticket.issue_type}</td>
                    <td class="px-6 py-4">${ticket.department}</td>
                    <td class="px-6 py-4">${ticket.authorized}</td>
                    <td class="px-6 py-4 max-w-xs truncate" title="${ticket.issue_details}">${ticket.issue_details}</td>
                    <td class="px-6 py-4"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(ticket.issue_status)}">${ticket.issue_status}</span></td>
                    <td class="px-6 py-4 max-w-xs truncate" title="${ticket.action_update || ''}">${ticket.action_update || ''}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        function getStatusColor(status) {
            switch (status) {
                case 'PENDING': return 'bg-orange-100 text-orange-800';
                case 'ACCEPTED': return 'bg-blue-100 text-blue-800';
                case 'REVIEWED': return 'bg-yellow-100 text-yellow-800';
                case 'UNDER PROCESS': return 'bg-purple-100 text-purple-800';
                case 'COMPLETED': return 'bg-green-100 text-green-800';
                default: return 'bg-gray-100 text-gray-800';
            }
        }

        // --- NOTICE BOARD SECTION ---
        async function fetchNotifications() {
            const { data, error } = await dbClient
                .from('notifications')
                .select('*')
                .eq('status', true) 
                .eq('store', currentUser.store) 
                .order('created_at', { ascending: false });

            if(error) {
                console.error("Error fetching notifications", error);
                return;
            }
            
            const container = document.getElementById('notifications-container');
            const noNotificationsEl = document.getElementById('no-notifications');
            container.innerHTML = '';
            await updateNotificationBubble(data.length); 

            if (data.length === 0) {
                noNotificationsEl.style.display = 'block';
                return;
            }
            noNotificationsEl.style.display = 'none';

            data.forEach(notification => {
                const card = document.createElement('div');
                card.id = `notification-${notification.id}`;
                card.className = 'bg-white p-5 rounded-lg shadow flex justify-between items-start';
                card.innerHTML = `
                    <div>
                        <div class="flex items-center mb-2">
                           <h3 class="font-bold text-lg text-gray-800">${notification.title}</h3>
                           <span class="ml-3 text-xs text-gray-400">${new Date(notification.created_at).toLocaleString()}</span>
                        </div>
                        <p class="text-gray-600">${notification.message}</p>
                    </div>
                    <button data-id="${notification.id}" class="ack-btn ml-4 flex-shrink-0 bg-green-500 text-white font-semibold py-1 px-3 rounded-md hover:bg-green-600 transition">OK</button>
                `;
                container.appendChild(card);
            });

            document.querySelectorAll('.ack-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const notificationId = btn.dataset.id;
                    openRemarkModal(notificationId);
                });
            });
        }

        // --- NOTIFICATION BUBBLE LOGIC ---
        async function updateNotificationBubble(explicitCount = null) {
            let count = explicitCount;
            if (count === null) {
                if (!currentUser) {
                    notificationBubble.classList.add('hidden');
                    return;
                }
                const { count: notifCount, error } = await dbClient
                    .from('notifications')
                    .select('*', { count: 'exact', head: true })
                    .eq('status', true)
                    .eq('store', currentUser.store);
                if (error) { 
                    console.error("Error counting notifications:", error);
                    return; 
                }
                count = notifCount || 0;
            }
            
            if (count > currentNotificationCount && !isInitialNotifCheck) {
                const audio = document.getElementById('notification-sound');
                if (audio) {
                    audio.play().catch(e => console.warn("Audio autoplay was prevented by the browser."));
                }
            }

            currentNotificationCount = count;
            isInitialNotifCheck = false; 

            if (count > 0) {
                notificationBubble.textContent = count > 99 ? '99+' : count;
                notificationBubble.classList.remove('hidden');
            } else {
                notificationBubble.textContent = '';
                notificationBubble.classList.add('hidden');
            }
        }
        
        // --- REMARK MODAL ---
        const remarkModal = document.getElementById('remark-modal');
        const submitRemarkBtn = document.getElementById('submit-remark-btn');
        const cancelRemarkBtn = document.getElementById('cancel-remark-btn');
        const remarkErrorEl = document.getElementById('remark-error');
        let currentNotificationId = null;

        function openRemarkModal(id) {
            currentNotificationId = id;
            remarkErrorEl.textContent = '';
            remarkModal.style.display = 'flex';
        }
        
        function closeRemarkModal() {
            document.getElementById('remark-textarea').value = '';
            remarkErrorEl.textContent = '';
            remarkModal.style.display = 'none';
            currentNotificationId = null;
        }

        submitRemarkBtn.addEventListener('click', async () => {
            const remark = document.getElementById('remark-textarea').value;
            remarkErrorEl.textContent = '';
            if (!remark.trim()) {
                remarkErrorEl.textContent = 'Remark cannot be empty.';
                return;
            }
            submitRemarkBtn.disabled = true;
            submitRemarkBtn.textContent = 'Saving...';

            const { error } = await dbClient
                .from('notifications')
                .update({ 
                    response: remark, 
                    status: false 
                })
                .eq('id', currentNotificationId);

            submitRemarkBtn.disabled = false;
            submitRemarkBtn.textContent = 'OK';

            if (error) {
                remarkErrorEl.textContent = 'Failed to save. Please try again.';
                console.error('Remark update error:', error);
            } else {
                const cardToRemove = document.getElementById(`notification-${currentNotificationId}`);
                if (cardToRemove) cardToRemove.remove();
                await updateNotificationBubble(Math.max(0, currentNotificationCount - 1));

                if (document.getElementById('notifications-container').children.length === 0) {
                    document.getElementById('no-notifications').style.display = 'block';
                }
                closeRemarkModal();
            }
        });

        cancelRemarkBtn.addEventListener('click', closeRemarkModal);
        
        // --- TICKET DETAILS MODAL ---
        const ticketDetailsModal = document.getElementById('ticket-details-modal');
        const ticketDetailsContent = document.getElementById('ticket-details-content');
        const ticketDetailsActions = document.getElementById('ticket-details-actions');
        const closeDetailsModalBtn = document.getElementById('close-details-modal-btn');
        const closeDetailsModalBtnBottom = document.getElementById('close-details-modal-btn-bottom');
        const activeTicketsTbody = document.getElementById('active-tickets-body');
        const closedTicketsTbody = document.getElementById('closed-tickets-body');

        // CHANGED: Logic to conditionally show image preview or file download link
        function showTicketDetailsModal(ticket) {
            const issueDate = ticket.issue_date ? new Date(ticket.issue_date).toLocaleString() : 'N/A';
            const closeDate = ticket.issue_close_dt ? new Date(ticket.issue_close_dt).toLocaleString() : 'N/A';
            
            ticketDetailsActions.innerHTML = ''; 

            let attachmentHTML = '';
            if (ticket.image_url) {
                const url = ticket.image_url;
                const fileName = decodeURIComponent(url.split('/').pop().split('?')[0].split('_').slice(2).join('_'));
                const isImage = /\.(jpe?g|png|gif|webp|svg)$/i.test(fileName);
                
                if (isImage) {
                    attachmentHTML = `
                    <p class="font-semibold text-gray-500 col-span-1">Attachment:</p>
                    <div class="col-span-2">
                        <a href="${url}" target="_blank" rel="noopener noreferrer">
                            <img src="${url}" alt="Ticket Attachment" class="max-h-40 rounded border cursor-pointer">
                        </a>
                    </div>`;
                } else {
                    attachmentHTML = `
                    <p class="font-semibold text-gray-500 col-span-1">Attachment:</p>
                    <div class="col-span-2">
                        <a href="${url}" target="_blank" rel="noopener noreferrer" class="text-indigo-600 hover:text-indigo-800 hover:underline break-all">
                            ${fileName}
                        </a>
                    </div>`;
                }
            }

            ticketDetailsContent.innerHTML = `
                <div class="grid grid-cols-3 gap-y-3 gap-x-2">
                    <p class="font-semibold text-gray-500 col-span-1">Status:</p>
                    <p class="col-span-2"><span class="px-2 py-1 text-xs font-semibold rounded-full ${getStatusColor(ticket.issue_status)}">${ticket.issue_status}</span></p>
                    <p class="font-semibold text-gray-500 col-span-1">Issue Date:</p>
                    <p class="col-span-2">${issueDate}</p>
                    ${ticket.issue_status === 'COMPLETED' ? `<p class="font-semibold text-gray-500 col-span-1">Close Date:</p><p class="col-span-2">${closeDate}</p>` : ''}
                    <p class="font-semibold text-gray-500 col-span-1">Store:</p>
                    <p class="col-span-2">${ticket.store_name || ''}</p>
                    <p class="font-semibold text-gray-500 col-span-1">Raised By:</p>
                    <p class="col-span-2">${ticket.person_name || ''}</p>
                    <p class="font-semibold text-gray-500 col-span-1">Issue Type:</p>
                    <p class="col-span-2">${ticket.issue_type || ''}</p>
                    <p class="font-semibold text-gray-500 col-span-1">Department:</p>
                    <p class="col-span-2">${ticket.department || ''}</p>
                    <p class="font-semibold text-gray-500 col-span-1">Authorized:</p>
                    <p class="col-span-2">${ticket.authorized || ''}</p>
                    <p class="font-semibold text-gray-500 col-span-1">Details:</p>
                    <p class="col-span-2 break-words">${ticket.issue_details || ''}</p>
                    <p class="font-semibold text-gray-500 col-span-1">Last Update:</p>
                    <p class="col-span-2 break-words">${ticket.action_update || ''}</p>
                    ${ticket.reopen_reason ? `<p class="font-semibold text-gray-500 col-span-1">Last Re-open Reason:</p><p class="col-span-2 break-words">${ticket.reopen_reason}</p>` : ''}
                    ${attachmentHTML}
                </div>
            `;
            
            if (ticket.issue_status === 'COMPLETED') {
                const reopenBtn = document.createElement('button');
                reopenBtn.id = 'reopen-ticket-btn';
                reopenBtn.textContent = 'Re-open Ticket';
                reopenBtn.className = 'w-full px-4 py-2 bg-yellow-500 text-white font-semibold rounded-md hover:bg-yellow-600';
                reopenBtn.onclick = () => {
                    closeTicketDetailsModal();
                    openReopenModal(ticket);
                };
                ticketDetailsActions.appendChild(reopenBtn);
            }

            ticketDetailsModal.style.display = 'flex';
        }

        function closeTicketDetailsModal() {
            ticketDetailsModal.style.display = 'none';
        }
        
        closeDetailsModalBtn.addEventListener('click', closeTicketDetailsModal);
        closeDetailsModalBtnBottom.addEventListener('click', closeTicketDetailsModal);

        const tableClickHandler = (event) => {
            const row = event.target.closest('tr');
            if (row && row.hasAttribute('data-ticket')) {
                const ticketData = JSON.parse(row.getAttribute('data-ticket'));
                showTicketDetailsModal(ticketData);
            }
        };
        
        activeTicketsTbody.addEventListener('click', tableClickHandler);
        closedTicketsTbody.addEventListener('click', tableClickHandler);
        
        // --- RE-OPEN TICKET MODAL LOGIC ---
        function openReopenModal(ticket) {
            currentTicketToReopen = ticket;
            reopenReasonTextarea.value = '';
            reopenErrorEl.textContent = '';
            reopenModal.style.display = 'flex';
        }

        function closeReopenModal() {
            reopenModal.style.display = 'none';
            currentTicketToReopen = null;
        }

        cancelReopenBtn.addEventListener('click', closeReopenModal);

        submitReopenBtn.addEventListener('click', async () => {
            const reason = reopenReasonTextarea.value.trim();
            if (!reason) {
                reopenErrorEl.textContent = 'Reason cannot be empty.';
                return;
            }

            if (!currentTicketToReopen) return;

            submitReopenBtn.disabled = true;
            submitReopenBtn.textContent = 'Re-opening...';

            const { error } = await dbClient
                .from('tickets')
                .update({ 
                    issue_status: 'PENDING', 
                    issue_close_dt: null,
                    action_update: `Ticket re-opened by user on ${new Date().toLocaleDateString()}.`,
                    reopen_reason: reason
                })
                .eq('id', currentTicketToReopen.id);
            
            submitReopenBtn.disabled = false;
            submitReopenBtn.textContent = 'Re-open';

            if (error) {
                showCustomAlert('Error', 'Failed to re-open ticket: ' + error.message, false);
            } else {
                closeReopenModal();
                closeTicketDetailsModal();
                showCustomAlert('Success', 'Ticket has been moved to Active.', true, () => {
                    fetchTickets(); 
                });
            }
        });
        
        // --- STARTUP ---
        checkSession();

        setInterval(() => {
            if (currentUser) {
                updateNotificationBubble();
            }
        }, 30000);
    </script>
</body>
</html>
