<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PB Admin Panel</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
        .table-container {
            scrollbar-width: none;
            -ms-overflow-style: none;
        }
        .table-container::-webkit-scrollbar {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">

    <div id="app" class="max-w-7xl mx-auto">

        <!-- Login Screen -->
        <div id="login-screen" class="min-h-screen flex items-center justify-center p-4">
            <div class="w-full max-w-md bg-white p-8 rounded-xl shadow-lg">
                <h1 class="text-3xl font-bold text-center text-gray-700 mb-6">Admin & Staff Login</h1>
                <div id="login-error" class="text-red-500 text-sm mb-4 text-center"></div>
                <form id="login-form">
                    <div class="mb-4">
                        <label for="user-id" class="block text-sm font-medium text-gray-600 mb-1">User ID</label>
                        <input type="text" id="user-id" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <div class="mb-6">
                        <label for="password" class="block text-sm font-medium text-gray-600 mb-1">Password</label>
                        <input type="password" id="password" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500" required>
                    </div>
                    <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700 transition">Login</button>
                </form>
            </div>
        </div>

        <!-- Main Content (Hidden by default) -->
        <div id="main-content" class="hidden">
            <header class="bg-white shadow-md p-4 flex justify-between items-center sticky top-0 z-10">
                <h1 class="text-xl font-bold text-indigo-600">PB EM Admin</h1>
                <div class="flex items-center">
                    <span id="welcome-user" class="text-gray-600 mr-4"></span>
                    <button id="logout-btn" class="bg-red-500 text-white text-sm font-medium py-2 px-4 rounded-lg hover:bg-red-600 transition">Logout</button>
                </div>
            </header>

            <!-- Tab Navigation -->
            <nav class="bg-white shadow-sm">
                <div class="max-w-7xl mx-auto px-4">
                    <div class="flex justify-start space-x-8">
                        <button data-tab="tickets" class="tab-btn font-semibold py-4 px-1 border-b-2 border-indigo-500 text-indigo-600">Tickets</button>
                        <button data-tab="notifications" class="tab-btn font-semibold py-4 px-1 border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700">Notifications</button>
                        <button data-tab="send-notification" class="tab-btn font-semibold py-4 px-1 border-b-2 border-transparent text-gray-500 hover:border-gray-300 hover:text-gray-700">Send Notification</button>
                    </div>
                </div>
            </nav>

            <main class="p-4 space-y-8">
                <!-- Section 1: Tickets -->
                <div id="tickets" class="tab-content space-y-8">
                    <div class="bg-white p-4 rounded-lg shadow-md">
                        <h3 class="font-bold text-lg mb-4">Filter Tickets by Issue Date</h3>
                        <div class="flex items-center space-x-4">
                            <div>
                                <label for="from-date" class="block text-sm font-medium text-gray-700">From</label>
                                <input type="date" id="from-date" class="mt-1 p-2 border rounded-md">
                            </div>
                            <div>
                                <label for="to-date" class="block text-sm font-medium text-gray-700">To</label>
                                <input type="date" id="to-date" class="mt-1 p-2 border rounded-md">
                            </div>
                            <button id="filter-btn" class="self-end bg-indigo-600 text-white py-2 px-4 rounded-md hover:bg-indigo-700">Apply Filter</button>
                             <button id="clear-filter-btn" class="self-end bg-gray-500 text-white py-2 px-4 rounded-md hover:bg-gray-600">Clear</button>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Active Tickets</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md overflow-hidden">
                           <div class="table-container overflow-x-auto">
                                <table class="w-full min-w-max text-sm text-left">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3">Issue Date</th>
                                            <th class="px-6 py-3">Store</th>
                                            <th class="px-6 py-3">Issue Type</th>
                                            <th class="px-6 py-3">Details</th>
                                            <th class="px-6 py-3">Authorized</th>
                                            <th class="px-6 py-3">Status</th>
                                            <th class="px-6 py-3">Action Update</th>
                                            <th class="px-6 py-3">Action</th>
                                        </tr>
                                    </thead>
                                    <tbody id="active-tickets-body"></tbody>
                                </table>
                           </div>
                           <p id="no-active-tickets" class="text-center py-4 hidden">No active tickets found.</p>
                        </div>
                    </div>
                    <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Closed Tickets</h2>
                        <div class="bg-white p-4 rounded-lg shadow-md overflow-hidden">
                             <div class="table-container overflow-x-auto">
                                <table class="w-full min-w-max text-sm text-left">
                                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                                        <tr>
                                            <th class="px-6 py-3">Close Date</th>
                                            <th class="px-6 py-3">Issue Date</th>
                                            <th class="px-6 py-3">Store</th>
                                            <th class="px-6 py-3">Issue Type</th>
                                            <th class="px-6 py-3">Details</th>
                                             <th class="px-6 py-3">Authorized</th>
                                            <th class="px-6 py-3">Final Update</th>
                                        </tr>
                                    </thead>
                                    <tbody id="closed-tickets-body"></tbody>
                                </table>
                             </div>
                             <p id="no-closed-tickets" class="text-center py-4 hidden">No closed tickets found.</p>
                        </div>
                    </div>
                </div>

                <!-- Section 2: Notifications -->
                <div id="notifications" class="tab-content hidden space-y-8">
                     <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Pending Notifications</h2>
                        <div id="pending-notifications-container" class="space-y-4"></div>
                        <p id="no-pending-notifications" class="text-center py-4 bg-white rounded-lg shadow-md hidden">No pending notifications.</p>
                    </div>
                     <div>
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Responded Notifications</h2>
                        <div id="responded-notifications-container" class="space-y-4"></div>
                        <p id="no-responded-notifications" class="text-center py-4 bg-white rounded-lg shadow-md hidden">No responded notifications.</p>
                    </div>
                </div>

                <!-- Section 3: Send Notification -->
                <div id="send-notification" class="tab-content hidden">
                    <div class="bg-white p-6 rounded-lg shadow-md max-w-lg mx-auto">
                        <h2 class="text-2xl font-bold mb-4 text-gray-700">Send a New Notification</h2>
                        <form id="notification-form" class="space-y-4">
                            <div>
                                <label for="store-select" class="block text-sm font-medium text-gray-700">Select Store</label>
                                <select id="store-select" class="mt-1 block w-full p-2 border rounded-md" required></select>
                            </div>
                            <div>
                                <label for="notification-title" class="block text-sm font-medium text-gray-700">Title</label>
                                <input type="text" id="notification-title" class="mt-1 block w-full p-2 border rounded-md" required>
                            </div>
                            <div>
                                <label for="notification-message" class="block text-sm font-medium text-gray-700">Message</label>
                                <textarea id="notification-message" rows="4" class="mt-1 block w-full p-2 border rounded-md" required></textarea>
                            </div>
                            <button type="submit" class="w-full bg-indigo-600 text-white font-semibold py-2 rounded-lg hover:bg-indigo-700">Send Notification</button>
                        </form>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <script type="module">
        const SUPABASE_URL = 'https://dfepjaivpgomxsjbxnhz.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImRmZXBqYWl2cGdvbXhzamJ4bmh6Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3NDk4MjY0NTMsImV4cCI6MjA2NTQwMjQ1M30.5ASDRBIH0CQ-4d2_1g8hfsZlotOp1EbU9v9nZXZdRIM';
        
        if (SUPABASE_URL === 'YOUR_SUPABASE_URL' || SUPABASE_ANON_KEY === 'YOUR_SUPABASE_ANON_KEY') {
            document.getElementById('app').innerHTML = `<div class="p-4 text-center text-red-700 bg-red-100">Please configure Supabase credentials in the script.</div>`;
            throw new Error("Supabase credentials not set.");
        }
        
        const { createClient } = supabase;
        const dbClient = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

        let currentUser = null;
        const statusOptions = ['PENDING', 'ACCEPTED', 'REVIEWED', 'UNDER PROCESS', 'COMPLETED'];

        // DOM Elements
        const loginScreen = document.getElementById('login-screen');
        const mainContent = document.getElementById('main-content');
        const loginForm = document.getElementById('login-form');
        const loginError = document.getElementById('login-error');
        const logoutBtn = document.getElementById('logout-btn');
        const welcomeUserEl = document.getElementById('welcome-user');
        const tabBtns = document.querySelectorAll('.tab-btn');
        const tabContents = document.querySelectorAll('.tab-content');

        // --- AUTH & INITIALIZATION ---
        loginForm.addEventListener('submit', async (e) => {
            e.preventDefault();
            const userId = document.getElementById('user-id').value.trim();
            const password = document.getElementById('password').value.trim();
            loginError.textContent = '';

            const { data, error } = await dbClient.from('office_users').select('*').eq('user_id', userId).eq('password', password).single();

            if (error || !data) {
                loginError.textContent = 'Invalid User ID or password.';
                return;
            }
            currentUser = data;
            sessionStorage.setItem('officeCurrentUser', JSON.stringify(currentUser));
            initializeApp();
        });

        logoutBtn.addEventListener('click', () => {
            sessionStorage.removeItem('officeCurrentUser');
            location.reload();
        });

        function checkSession() {
            const user = sessionStorage.getItem('officeCurrentUser');
            if (user) {
                currentUser = JSON.parse(user);
                initializeApp();
            }
        }

        async function initializeApp() {
            loginScreen.style.display = 'none';
            mainContent.style.display = 'block';
            welcomeUserEl.textContent = `Welcome, ${currentUser.user_id}`;
            document.querySelector('[data-tab="tickets"]').click();
        }

        // --- TAB NAVIGATION ---
        tabBtns.forEach(btn => {
            btn.addEventListener('click', () => {
                const targetTab = btn.dataset.tab;
                tabBtns.forEach(b => {
                    b.classList.remove('border-indigo-500', 'text-indigo-600');
                    b.classList.add('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                });
                btn.classList.add('border-indigo-500', 'text-indigo-600');
                btn.classList.remove('border-transparent', 'text-gray-500', 'hover:border-gray-300', 'hover:text-gray-700');
                
                tabContents.forEach(c => c.style.display = 'none');
                document.getElementById(targetTab).style.display = 'block';

                if (targetTab === 'tickets') fetchTickets();
                if (targetTab === 'notifications') fetchAllNotifications();
                if (targetTab === 'send-notification') populateStoreDropdown();
            });
        });
        
        // --- TICKETS SECTION ---
        document.getElementById('filter-btn').addEventListener('click', fetchTickets);
        document.getElementById('clear-filter-btn').addEventListener('click', () => {
            document.getElementById('from-date').value = '';
            document.getElementById('to-date').value = '';
            fetchTickets();
        });

        async function fetchTickets() {
            let query = dbClient.from('tickets').select('*');

            if (!currentUser.is_admin) {
                query = query.eq('authorized', currentUser.user_id);
            }
            
            const fromDate = document.getElementById('from-date').value;
            const toDate = document.getElementById('to-date').value;

            if (fromDate) query = query.gte('issue_date', new Date(fromDate).toISOString());
            if (toDate) query = query.lte('issue_date', new Date(toDate).toISOString());

            const { data, error } = await query.order('issue_date', { ascending: false });

            if (error) {
                console.error('Error fetching tickets:', error);
                return;
            }
            
            const activeTickets = data.filter(t => t.issue_status !== 'COMPLETED');
            const closedTickets = data.filter(t => t.issue_status === 'COMPLETED');
            
            renderActiveTickets(activeTickets);
            renderClosedTickets(closedTickets);
        }

        function renderActiveTickets(tickets) {
            const tbody = document.getElementById('active-tickets-body');
            const noDataEl = document.getElementById('no-active-tickets');
            tbody.innerHTML = '';
            if (tickets.length === 0) {
                noDataEl.style.display = 'block';
                return;
            }
            noDataEl.style.display = 'none';

            tickets.forEach(ticket => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b';
                tr.innerHTML = `
                    <td class="px-6 py-4">${new Date(ticket.issue_date).toLocaleString()}</td>
                    <td class="px-6 py-4">${ticket.store_name}</td>
                    <td class="px-6 py-4 font-semibold">${ticket.issue_type}</td>
                    <td class="px-6 py-4 max-w-xs truncate" title="${ticket.issue_details}">${ticket.issue_details}</td>
                    <td class="px-6 py-4">${ticket.authorized}</td>
                    <td class="px-6 py-4">
                        <select id="status-${ticket.id}" class="p-1 border rounded-md bg-gray-50">
                            ${statusOptions.map(s => `<option value="${s}" ${s === ticket.issue_status ? 'selected' : ''}>${s}</option>`).join('')}
                        </select>
                    </td>
                    <td class="px-6 py-4">
                        <textarea id="update-${ticket.id}" class="w-full p-1 border rounded-md" rows="2">${ticket.action_update || ''}</textarea>
                    </td>
                    <td class="px-6 py-4">
                        <button data-id="${ticket.id}" class="update-ticket-btn bg-green-500 text-white py-1 px-3 rounded hover:bg-green-600">Submit</button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        document.getElementById('active-tickets-body').addEventListener('click', async (e) => {
            if (e.target.classList.contains('update-ticket-btn')) {
                const ticketId = e.target.dataset.id;
                const newStatus = document.getElementById(`status-${ticketId}`).value;
                const newUpdate = document.getElementById(`update-${ticketId}`).value;

                let updateData = {
                    issue_status: newStatus,
                    action_update: newUpdate
                };

                if (newStatus === 'COMPLETED') {
                    updateData.issue_close_dt = new Date().toISOString();
                }

                const { error } = await dbClient.from('tickets').update(updateData).eq('id', ticketId);

                if (error) {
                    alert('Failed to update ticket.');
                    console.error('Update error:', error);
                } else {
                    alert('Ticket updated successfully!');
                    fetchTickets();
                }
            }
        });

        function renderClosedTickets(tickets) {
            const tbody = document.getElementById('closed-tickets-body');
            const noDataEl = document.getElementById('no-closed-tickets');
            tbody.innerHTML = '';
            if (tickets.length === 0) {
                noDataEl.style.display = 'block';
                return;
            }
            noDataEl.style.display = 'none';
            tickets.forEach(ticket => {
                const tr = document.createElement('tr');
                tr.className = 'bg-white border-b';
                tr.innerHTML = `
                    <td class="px-6 py-4">${new Date(ticket.issue_close_dt).toLocaleString()}</td>
                    <td class="px-6 py-4">${new Date(ticket.issue_date).toLocaleString()}</td>
                    <td class="px-6 py-4">${ticket.store_name}</td>
                    <td class="px-6 py-4 font-semibold">${ticket.issue_type}</td>
                    <td class="px-6 py-4 max-w-xs truncate" title="${ticket.issue_details}">${ticket.issue_details}</td>
                    <td class="px-6 py-4">${ticket.authorized}</td>
                    <td class="px-6 py-4 max-w-xs truncate" title="${ticket.action_update}">${ticket.action_update}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // --- NOTIFICATIONS SECTION ---
        async function fetchAllNotifications() {
            const { data, error } = await dbClient.from('notifications').select('*').order('created_at', { ascending: false });
            if (error) {
                console.error("Error fetching notifications", error);
                return;
            }
            const pending = data.filter(n => n.status === true);
            const responded = data.filter(n => n.status === false);
            
            renderNotifications('pending-notifications-container', pending, 'no-pending-notifications');
            renderNotifications('responded-notifications-container', responded, 'no-responded-notifications');
        }
        
        function renderNotifications(containerId, notifications, noDataElId) {
            const container = document.getElementById(containerId);
            const noDataEl = document.getElementById(noDataElId);
            container.innerHTML = '';
            
            if (notifications.length === 0) {
                noDataEl.style.display = 'block';
                return;
            }
            noDataEl.style.display = 'none';

            notifications.forEach(n => {
                const card = document.createElement('div');
                card.className = 'bg-white p-4 rounded-lg shadow';
                card.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <h3 class="font-bold text-lg">${n.title}</h3>
                            <p class="text-sm text-gray-500">To: ${n.store} | On: ${new Date(n.created_at).toLocaleString()}</p>
                            <p class="mt-2">${n.message}</p>
                            ${n.response ? `<p class="mt-2 text-sm text-blue-600 bg-blue-50 p-2 rounded-md"><b>Response:</b> ${n.response}</p>` : ''}
                        </div>
                        <span class="text-xs font-semibold px-2 py-1 rounded-full ${n.status ? 'bg-yellow-100 text-yellow-800' : 'bg-green-100 text-green-800'}">
                            ${n.status ? 'Pending' : 'Responded'}
                        </span>
                    </div>
                `;
                container.appendChild(card);
            });
        }
        
        // --- SEND NOTIFICATION SECTION ---
        async function populateStoreDropdown() {
            const { data, error } = await dbClient.from('store_users').select('store');
            if(error) {
                console.error("Error fetching stores", error);
                return;
            }
            const storeSelect = document.getElementById('store-select');
            storeSelect.innerHTML = '<option value="All">All Stores</option>';
            const uniqueStores = [...new Set(data.map(item => item.store))];
            uniqueStores.forEach(store => {
                storeSelect.innerHTML += `<option value="${store}">${store}</option>`;
            });
        }

        document.getElementById('notification-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const store = document.getElementById('store-select').value;
            const title = document.getElementById('notification-title').value;
            const message = document.getElementById('notification-message').value;

            const notification = { title, message, status: true };
            
            if (store === 'All') {
                const { data: stores, error: storeError } = await dbClient.from('store_users').select('store');
                 if (storeError) {
                    alert('Could not fetch store list to send to all.');
                    return;
                }
                const uniqueStores = [...new Set(stores.map(item => item.store))];
                const allNotifications = uniqueStores.map(s => ({...notification, store: s}));

                const { error } = await dbClient.from('notifications').insert(allNotifications);
                 if (error) {
                    alert('Failed to send notification to all stores.');
                } else {
                    alert('Notification sent to all stores successfully!');
                }
            } else {
                notification.store = store;
                const { error } = await dbClient.from('notifications').insert([notification]);
                if (error) {
                    alert('Failed to send notification.');
                } else {
                    alert('Notification sent successfully!');
                }
            }
            e.target.reset();
        });

        // --- STARTUP ---
        checkSession();
    </script>
</body>
</html>

